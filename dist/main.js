(()=>{"use strict";class t{constructor(t){this.baseUrl=t}getAllTickets(t){const e=new XMLHttpRequest;e.addEventListener("readystatechange",(()=>{if(4===e.readyState)try{const i=JSON.parse(e.responseText);return t(i),i}catch(t){console.log(t)}})),e.open("GET",`${this.baseUrl}?method=allTickets`),e.send()}getTicketById(t,e){const i=new XMLHttpRequest;i.addEventListener("readystatechange",(()=>{if(4===i.readyState)try{const t=JSON.parse(i.responseText);e(t)}catch(t){console.log(t)}})),i.open("GET",`${this.baseUrl}?method=ticketById&id=${t}`),i.send()}createTicket(t,e,i){const d=new XMLHttpRequest;d.addEventListener("readystatechange",(()=>{if(4===d.readyState)try{const t=JSON.parse(d.responseText);i(t)}catch(t){console.log(t)}}));const s=new FormData;s.append("name",t),s.append("description",e),d.open("POST",`${this.baseUrl}?method=createTicket`),d.send(s)}changeStatus(t,e){const i=new XMLHttpRequest;i.addEventListener("readystatechange",(()=>{if(4===i.readyState)try{const t=JSON.parse(i.responseText);e(t)}catch(t){console.log(t)}})),i.open("PATCH",`${this.baseUrl}?method=changeStatus&id=${t}`),i.send()}editTicket(t,e,i,d){const s=new XMLHttpRequest;s.addEventListener("readystatechange",(()=>{if(4===s.readyState)try{const t=s.responseText;d(t)}catch(t){console.log(t)}}));const c=new FormData;c.append("name",e),c.append("description",i),s.open("PATCH",`${this.baseUrl}?method=editTicket&id=${t}`),s.send(c)}deleteTicket(t,e){const i=new XMLHttpRequest;i.addEventListener("readystatechange",(()=>{if(4===i.readyState)try{const t=i.responseText;e(t)}catch(t){console.log(t)}})),i.open("DELETE",`${this.baseUrl}?method=deleteTicket&id=${t}`),i.send()}}class e{static createCard(t,e,i,d,s){const c=document.createElement("div");c.classList.add("ticket"),c.dataset.id=t;const n=document.createElement("div");n.classList.add("ticket__main");const a=document.createElement("div");a.classList.add("left-part");const o=document.createElement("input");o.classList.add("ticket-checkbox"),o.type="checkbox",o.checked=d,a.appendChild(o);const r=document.createElement("span");r.classList.add("ticket-name"),r.textContent=e,a.appendChild(r),n.appendChild(a);const l=document.createElement("div");l.classList.add("right-part");const h=document.createElement("span");h.classList.add("ticket-time"),h.textContent=s,l.appendChild(h);const p=document.createElement("button");p.classList.add("ticket-edit"),p.textContent="✎",l.appendChild(p);const k=document.createElement("button");k.classList.add("ticket-delete"),k.textContent="X",l.appendChild(k),n.appendChild(l),c.appendChild(n);const u=document.createElement("div");u.classList.add("ticket__sub");const T=document.createElement("pre");return T.classList.add("ticket-description"),T.textContent=i,u.appendChild(T),c.appendChild(u),c}}class i{#t;#e;constructor(e){this.container=e,this.ticketBase=new t("http://localhost:7070/"),this.addNewTicketBtn=e.querySelector(".add-ticket"),this.ticketsContainer=e.querySelector(".tickets-container"),this.addEditTicketPopup=e.querySelector(".add-edit-ticket"),this.addEditTicketTitle=this.addEditTicketPopup.querySelector(".form-title"),this.addEditTicketName=this.addEditTicketPopup.querySelectorAll(".form-input")[0],this.addEditTicketDescription=this.addEditTicketPopup.querySelectorAll(".form-input")[1],this.addEditCloseBtn=this.addEditTicketPopup.querySelector(".form-reset"),this.addEditAplyBtn=this.addEditTicketPopup.querySelector(".form-add"),this.deleteTicketPopup=e.querySelector(".delete-ticket"),this.deleteTicketPopupCloseBtn=this.deleteTicketPopup.querySelector(".form-reset"),this.deleteTicketPopupApplyBtn=this.deleteTicketPopup.querySelector(".form-add")}setHandlers(){this.addNewTicketBtn.addEventListener("click",this.onAddNewTicketBtn.bind(this)),this.addEditCloseBtn.addEventListener("click",this.onAddEditCloseBtn.bind(this)),this.addEditAplyBtn.addEventListener("click",this.onAddEditAplyBtn.bind(this)),this.ticketsContainer.addEventListener("click",this.onTicketsContainer.bind(this)),this.deleteTicketPopupCloseBtn.addEventListener("click",this.closeDeleteTicketWindow.bind(this)),this.deleteTicketPopupApplyBtn.addEventListener("click",this.deleteTicket.bind(this))}get addOrEdit(){return this.#e}set addOrEdit(t){this.#e=t}get currentTicket(){return this.#t}set currentTicket(t){this.#t=t}start(){this.setHandlers(),this.ticketBase.getAllTickets(this.initTable.bind(this))}initTable(t){for(const e of t)this.addNewTicket(e)}onAddNewTicketBtn(){this.addEditTicketPopup.style.visibility="visible",this.addEditTicketTitle.textContent="Добавить Тикет",this.addOrEdit="add"}onAddEditCloseBtn(){this.addEditTicketPopup.style.visibility="hidden",this.addEditTicketPopup.reset(),this.addEditTicketDescription.textContent=""}onAddEditAplyBtn(t){t.preventDefault();const i=new FormData(this.addEditTicketPopup),d=i.get("name").trim(),s=i.get("description").trim();d&&("add"===this.addOrEdit?this.ticketBase.createTicket(d,s,(t=>{const{id:i,name:d,description:s,status:c,created:n}=t;this.ticketsContainer.appendChild(e.createCard(i,d,s,c,n))})):"edit"===this.addOrEdit&&this.ticketBase.editTicket(this.currentTicket.dataset.id,d,s,(()=>{this.currentTicket.querySelector(".ticket-name").textContent=d,this.currentTicket.querySelector(".ticket-description").textContent=s,this.currentTicket=void 0})),this.addEditTicketPopup.style.visibility="hidden",this.addEditTicketPopup.reset(),this.addEditTicketDescription.textContent="")}onTicketsContainer(t){const e=t.target.classList,i=t.target.closest(".ticket");e.contains("ticket__main")||e.contains("ticket-name")?this.showDescription(i):e.contains("ticket-checkbox")?this.changeStatus(i):e.contains("ticket-delete")?(this.currentTicket=i,this.showDeleteTicketWindow()):e.contains("ticket-edit")&&(this.currentTicket=i,this.showEditTicketWindow())}showDescription(t){this.ticketBase.getTicketById(t.dataset.id,(e=>{const i=t.querySelector(".ticket__sub");if("block"===i.style.display)i.style.display="none";else{const{description:t}=e;i.querySelector(".ticket-description").textContent=t,i.style.display="block"}}))}changeStatus(t){this.ticketBase.changeStatus(t.dataset.id,(t=>{console.log(t)}))}showEditTicketWindow(){this.ticketBase.getTicketById(this.currentTicket.dataset.id,(t=>{const{name:e,description:i}=t;this.addEditTicketPopup.style.visibility="visible",this.addEditTicketTitle.textContent="Изменить Тикет",this.addEditTicketName.value=e,this.addEditTicketDescription.textContent=i,this.addOrEdit="edit"}))}showDeleteTicketWindow(){this.deleteTicketPopup.style.visibility="visible"}closeDeleteTicketWindow(){this.deleteTicketPopup.style.visibility="hidden",this.currentTicket=void 0}deleteTicket(t){t.preventDefault(),this.ticketBase.deleteTicket(this.currentTicket.dataset.id,(t=>{this.currentTicket.remove(),this.currentTicket=void 0,this.closeDeleteTicketWindow()}))}addNewTicket(t){const{id:i,name:d,description:s,status:c,created:n}=t;this.ticketsContainer.appendChild(e.createCard(i,d,s,c,n))}}document.addEventListener("DOMContentLoaded",(()=>{const t=document.querySelector(".container");new i(t).start()}))})();